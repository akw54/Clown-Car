angular.module('app.controllers', [])
  
.controller('paymentCtrl', ['$scope', '$stateParams', // The following is the constructor function for this page's controller. See https://docs.angularjs.org/guide/controller
// You can include any angular dependencies as parameters for this function
// TIP: Access Route Parameters for your page via $stateParams.parameterName
function ($scope, $stateParams) {


}])
   
.controller('settingsCtrl', ['$scope', '$stateParams', // The following is the constructor function for this page's controller. See https://docs.angularjs.org/guide/controller
// You can include any angular dependencies as parameters for this function
// TIP: Access Route Parameters for your page via $stateParams.parameterName
function ($scope, $stateParams) {


}])
   
.controller('profileCtrl', ['$scope', '$stateParams', // The following is the constructor function for this page's controller. See https://docs.angularjs.org/guide/controller
// You can include any angular dependencies as parameters for this function
// TIP: Access Route Parameters for your page via $stateParams.parameterName
function ($scope, $stateParams) {


}])
   
.controller('rideHistoryCtrl', ['$scope', '$stateParams', // The following is the constructor function for this page's controller. See https://docs.angularjs.org/guide/controller
// You can include any angular dependencies as parameters for this function
// TIP: Access Route Parameters for your page via $stateParams.parameterName
function ($scope, $stateParams) {


}])
   
.controller('clownCarCtrl', ['$scope', '$stateParams', // The following is the constructor function for this page's controller. See https://docs.angularjs.org/guide/controller
// You can include any angular dependencies as parameters for this function
// TIP: Access Route Parameters for your page via $stateParams.parameterName
function ($scope, $stateParams) {


}])
   
.controller('rideCtrl', ['$scope', '$stateParams', angular.module('app.controllers', [])
  
.controller('paymentCtrl', ['$scope', '$stateParams', // The following is the constructor function for this page's controller. See https://docs.angularjs.org/guide/controller
// You can include any angular dependencies as parameters for this function
// TIP: Access Route Parameters for your page via $stateParams.parameterName
function ($scope, $stateParams) {


}])
   
.controller('settingsCtrl', ['$scope', '$stateParams', // The following is the constructor function for this page's controller. See https://docs.angularjs.org/guide/controller
// You can include any angular dependencies as parameters for this function
// TIP: Access Route Parameters for your page via $stateParams.parameterName
function ($scope, $stateParams) {


}])
   
.controller('profileCtrl', ['$scope', '$stateParams', // The following is the constructor function for this page's controller. See https://docs.angularjs.org/guide/controller
// You can include any angular dependencies as parameters for this function
// TIP: Access Route Parameters for your page via $stateParams.parameterName
function ($scope, $stateParams) {


}])
   
.controller('rideHistoryCtrl', ['$scope', '$stateParams', // The following is the constructor function for this page's controller. See https://docs.angularjs.org/guide/controller
// You can include any angular dependencies as parameters for this function
// TIP: Access Route Parameters for your page via $stateParams.parameterName
function ($scope, $stateParams) {


}])
   
.controller('clownCarCtrl', ['$scope', '$stateParams', // The following is the constructor function for this page's controller. See https://docs.angularjs.org/guide/controller
// You can include any angular dependencies as parameters for this function
// TIP: Access Route Parameters for your page via $stateParams.parameterName
function ($scope, $stateParams) {


}])
   
.controller('homeCtrl', ['$scope', '$stateParams', angular.module('app.controllers', [])
  
.controller('paymentCtrl', ['$scope', '$stateParams', // The following is the constructor function for this page's controller. See https://docs.angularjs.org/guide/controller
// You can include any angular dependencies as parameters for this function
// TIP: Access Route Parameters for your page via $stateParams.parameterName
function ($scope, $stateParams) {


}])
   
.controller('settingsCtrl', ['$scope', '$stateParams', // The following is the constructor function for this page's controller. See https://docs.angularjs.org/guide/controller
// You can include any angular dependencies as parameters for this function
// TIP: Access Route Parameters for your page via $stateParams.parameterName
function ($scope, $stateParams) {


}])
   
.controller('profileCtrl', ['$scope', '$stateParams', // The following is the constructor function for this page's controller. See https://docs.angularjs.org/guide/controller
// You can include any angular dependencies as parameters for this function
// TIP: Access Route Parameters for your page via $stateParams.parameterName
function ($scope, $stateParams) {


}])
   
.controller('rideHistoryCtrl', ['$scope', '$stateParams', // The following is the constructor function for this page's controller. See https://docs.angularjs.org/guide/controller
// You can include any angular dependencies as parameters for this function
// TIP: Access Route Parameters for your page via $stateParams.parameterName
function ($scope, $stateParams) {


}])
   
.controller('clownCarCtrl', ['$scope', '$stateParams', // The following is the constructor function for this page's controller. See https://docs.angularjs.org/guide/controller
// You can include any angular dependencies as parameters for this function
// TIP: Access Route Parameters for your page via $stateParams.parameterName
function ($scope, $stateParams) {


}])
   
.controller('homeCtrl', ['$scope', '$stateParams', angular.module('app.controllers', [])
  
.controller('paymentCtrl', ['$scope', '$stateParams', // The following is the constructor function for this page's controller. See https://docs.angularjs.org/guide/controller
// You can include any angular dependencies as parameters for this function
// TIP: Access Route Parameters for your page via $stateParams.parameterName
function ($scope, $stateParams) {


}])
   
.controller('settingsCtrl', ['$scope', '$stateParams', // The following is the constructor function for this page's controller. See https://docs.angularjs.org/guide/controller
// You can include any angular dependencies as parameters for this function
// TIP: Access Route Parameters for your page via $stateParams.parameterName
function ($scope, $stateParams) {


}])
   
.controller('profileCtrl', ['$scope', '$stateParams', // The following is the constructor function for this page's controller. See https://docs.angularjs.org/guide/controller
// You can include any angular dependencies as parameters for this function
// TIP: Access Route Parameters for your page via $stateParams.parameterName
function ($scope, $stateParams) {


}])
   
.controller('rideHistoryCtrl', ['$scope', '$stateParams', // The following is the constructor function for this page's controller. See https://docs.angularjs.org/guide/controller
// You can include any angular dependencies as parameters for this function
// TIP: Access Route Parameters for your page via $stateParams.parameterName
function ($scope, $stateParams) {


}])
   
.controller('clownCarCtrl', ['$scope', '$stateParams', // The following is the constructor function for this page's controller. See https://docs.angularjs.org/guide/controller
// You can include any angular dependencies as parameters for this function
// TIP: Access Route Parameters for your page via $stateParams.parameterName
function ($scope, $stateParams) {


}])
   
.controller('homeCtrl', ['$scope', '$stateParams', angular.module('app.controllers', [])
  
.controller('paymentCtrl', ['$scope', '$stateParams',
function ($scope, $stateParams) {


}])
   
.controller('settingsCtrl', ['$scope', '$stateParams',
function ($scope, $stateParams) {


}])
   
.controller('profileCtrl', ['$scope', '$stateParams',
function ($scope, $stateParams) {


}])
   
.controller('rideHistoryCtrl', ['$scope', '$stateParams',
function ($scope, $stateParams) {


}])
   
.controller('clownCarCtrl', ['$scope', '$stateParams',
function ($scope, $stateParams) {


}])

.controller('editAccountCtrl', ['$scope', '$stateParams', // The following is the constructor function for this page's controller. See https://docs.angularjs.org/guide/controller
// You can include any angular dependencies as parameters for this function
// TIP: Access Route Parameters for your page via $stateParams.parameterName
function ($scope, $stateParams) {

}])
   
.controller('rideCtrl', ['$scope', 'uiGmapGoogleMapApi', 'uiGmapIsReady', '$http', '$ionicPopup', '$timeout',
function($scope, uiGmapGoogleMapApi, uiGmapIsReady, $http, $ionicPopup, $timeout) {
    uiGmapGoogleMapApi.then(function(maps){
        $scope.map = {
            center: {
              latitude: 42.3314,
              longitude: -83.0458
            },
            zoom: 12,
            options: {
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                streetViewControl: false,
                mapTypeControl: false,
                scaleControl: false,
                rotateControl: false,
                zoomControl: false
            }, 
            showTraficLayer:false,
            styles: [{
                "featureType": "landscape.man_made",
                "elementType": "all",
                "stylers": [
                        {
                            "color": "#faf5ed"
                        },
                        {
                            "lightness": "0"
                        },
                        {
                            "gamma": "1"
                        }]
                },
                {
                    "featureType": "poi.park",
                    "elementType": "geometry.fill",
                    "stylers": [
                        {
                            "color": "#bae5a6"
                        }
                    ]
                },
                {
                    "featureType": "road",
                    "elementType": "all",
                    "stylers": [
                        {
                            "weight": "1.00"
                        },
                        {
                            "gamma": "1.8"
                        },
                        {
                            "saturation": "0"
                        }
                    ]
                },
                {
                    "featureType": "road",
                    "elementType": "geometry.fill",
                    "stylers": [
                        {
                            "hue": "#ffb200"
                        }
                    ]
                },
                {
                    "featureType": "road.arterial",
                    "elementType": "geometry.fill",
                    "stylers": [
                        {
                            "lightness": "0"
                        },
                        {
                            "gamma": "1"
                        }
                    ]
                },
                {
                    "featureType": "transit.station.airport",
                    "elementType": "all",
                    "stylers": [
                        {
                            "hue": "#b000ff"
                        },
                        {
                            "saturation": "23"
                        },
                        {
                            "lightness": "-4"
                        },
                        {
                            "gamma": "0.80"
                        }
                    ]
                },
                {
                    "featureType": "water",
                    "elementType": "all",
                    "stylers": [
                        {
                            "color": "#a0daf2"
                        }
                    ]
                }
        ]};
        
    });

    $scope.routes = [];
    var oldPaths = [], oldMarkers = [];
    $scope.changeRoute = function(rt) {
        $scope.cancelTrip();
        var route = $scope.routes[rt];
        clearPaths();
        clearMarkers();
        var polyPath = new google.maps.Polyline({
          path: route.path,
          geodesic: true,
          strokeColor: '#000FFF',
          strokeOpacity: 0.45,
          strokeWeight: 4
        });
        oldPaths.push(polyPath);
        polyPath.setMap($scope.maps);

        for (var i = 0; i < route.stops.length; i++) {
            oldMarkers.push(route.stops[i]);
            route.stops[i].setMap($scope.maps);
        }

        var pos = getLatLngCenter(route.path);
        if (!$scope.maps.getBounds().contains(pos)) { 
            $scope.maps.panTo(pos);  
        }
    }

    var rad2degr = function(rad) { return rad * 180 / Math.PI; }
    var degr2rad = function(degr) { return degr * Math.PI / 180; }

    var getLatLngCenter = function(latLngInDegr) {
        var sumX = 0;
        var sumY = 0;
        var sumZ = 0;

        for (var i=0; i<latLngInDegr.length; i++) {
            var lat = degr2rad(latLngInDegr[i].lat);
            var lng = degr2rad(latLngInDegr[i].lng);
            sumX += Math.cos(lat) * Math.cos(lng);
            sumY += Math.cos(lat) * Math.sin(lng);
            sumZ += Math.sin(lat);
        }

        var avgX = sumX / latLngInDegr.length;
        var avgY = sumY / latLngInDegr.length;
        var avgZ = sumZ / latLngInDegr.length;

        var lng = Math.atan2(avgY, avgX);
        var hyp = Math.sqrt(avgX * avgX + avgY * avgY);
        var lat = Math.atan2(avgZ, hyp);

        return ({
            lat : rad2degr(lat),
            lng : rad2degr(lng)});
    }

    var clearMarkers = function() {
        if (oldMarkers != null) {
          for (var i = 0; i < oldMarkers.length; i++) {
            oldMarkers[i].setMap(null);
          }
          oldMarkers = [];
        }
    }

    var clearTrip = function() {
        if ($scope.hasDropoff && $scope.hasPickup) {
          for (var i = 0; i < $scope.tripMarks.length; i++) {
            $scope.tripMarks[i].setMap(null);
          }
          $scope.tripMarks = [];
        }
    }
    
    var clearPaths = function() {
        if (oldPaths != null) {
          for (var i = 0; i < oldPaths.length; i++) {
            oldPaths[i].setMap(null);
          }
          oldPaths = [];
        }
    }

    $scope.showAlert = function() {
      var alertPopup = $ionicPopup.alert({
        title: 'Overview',
        template: 'Distance: 2.42mi\n' + 'Fare: $2.25'
      });

      alertPopup.then(function(res) {
      });
    };

    $scope.tripMarks = [];
    var showTrip = function() {
        clearMarkers();

        var map = $scope.maps;
        $scope.tripMarks.forEach(function(mark) {
            mark.setMap(map);
        });
    }

    uiGmapIsReady.promise()
    .then(function(instances) {
        $scope.maps = instances[0].map;

        $http({
            method : "GET",
            url : "https://data.detroitmi.gov/resource/hyjq-w7ws.json" // DDOT
        }).then(function mySucces(response) {
          this.response = response;
          this.pathCoords = [];
          this.markers = [];
          const markerSpace = 12; var markerCnt = 0;

          for (var i = 0; i < response.data.length; i++) {
            for (var j = 0; j < response.data[i].the_geom.coordinates.length; j++) {
                var lat = parseFloat(response.data[i].the_geom.coordinates[j][1]);
                var lng = parseFloat(response.data[i].the_geom.coordinates[j][0]);
                pathCoords.push({lat: lat, lng: lng});
                
                var marker;
                markerCnt++;
                if ((markerCnt === markerSpace) || (j === 0) || (j === response.data[i].the_geom.coordinates.length - 1)) {
                    markerCnt = 0;
                    var marker = new google.maps.Marker({
                        position: { lat: lat, lng: lng },
                        animation: google.maps.Animation.DROP
                    });
                    markers.push(marker);
                }
            }

            function capitalizeFirstLetter(string) {
                return string.charAt(0).toUpperCase() + string.slice(1);
            }

            var data = response.data[i];
            var cName = "", dir = "";

            data.rte_name.toLowerCase().split(" ").forEach(function(x) {
                cName += capitalizeFirstLetter(x) + " ";
            });

            data.direction.toLowerCase().split(" ").forEach(function(x) {
                dir += capitalizeFirstLetter(x) + " ";
            })

            var route = {
                id : i,
                name : cName,
                path : pathCoords,
                stops : markers,
                direction : dir,
                namedir : cName + " - " + dir
            }

            route.stops.forEach(function(marker) {
                google.maps.event.addListener(marker, 'click', function () {
                    if ($scope.hasPickup) {
                        $scope.tripMarks.push(this);
                        $scope.showDropoff();
                    } else if ($scope.hasDropoff && $scope.showPickup) {
                        $scope.cancelTrip();
                        $scope.tripMarks = [];
                    } else {
                        $scope.tripMarks.push(this);
                        $scope.showPickup();
                    }
                });
            })

            this.pathCoords = [];
            $scope.routes.push(route);
            this.markers = [];
          }


        });
    });

    $scope.hasPickup = false;
    $scope.hasDropoff = false;
    $scope.cancel = false;
    $scope.showPickup = function() {
        var confirmPopup = $ionicPopup.confirm({
            title: 'Confirm this as pickup location?'
        });

        confirmPopup.then(function(res) {
            if(res) {
                $scope.cancel = true;
                $scope.hasPickup = true;
                console.log('You are sure');
            } else {
                $scope.cancel = false;
                console.log('You are not sure');
            }
        });
    };

    $scope.showDropoff = function() {
        var confirmPopup = $ionicPopup.confirm({
            title: 'Confirm dropoff location?'
        });

        confirmPopup.then(function(res) {
            if(res) {
                $scope.cancel = false;
                $scope.hasDropoff = true;
                console.log('You are sure');
                $scope.showAlert();
            } else {
                $scope.cancel = false;
                console.log('You are not sure');
            }
        });

        showTrip();
    };

    $scope.cancelTrip = function() {
        if ($scope.hasPickup && $scope.hasDropoff) {
            var confirmCancel = $ionicPopup.confirm({
                title: 'Are you sure you want to cancel the trip?'
            })

            confirmCancel.then(function(res) {
                if (res) {
                    clearTrip();
                    $scope.tripMarks = [];
                    $scope.cancel = false;
                    $scope.hasPickup = false;
                    $scope.hasDropoff = false;
                }
            })
        } else {
            clearTrip();
            $scope.tripMarks = [];
            $scope.cancel = false;
            $scope.hasPickup = false;
            $scope.hasDropoff = false;
        }
    }

}])

])
])
])
 ])
   
.controller('editAccountCtrl', ['$scope', '$stateParams', // The following is the constructor function for this page's controller. See https://docs.angularjs.org/guide/controller
// You can include any angular dependencies as parameters for this function
// TIP: Access Route Parameters for your page via $stateParams.parameterName
function ($scope, $stateParams) {


}])
 